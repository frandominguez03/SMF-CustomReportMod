<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
/**
* @package manifest file for Custom Report Mod
* @version 1.4
* @author Joker (http://www.simplemachines.org/community/index.php?action=profile;u=226111)
* @copyright Copyright (c) 2014, Siddhartha Gupta
* @license http://www.mozilla.org/MPL/MPL-1.1.html
*/

/*
* Version: MPL 1.1
*
* The contents of this file are subject to the Mozilla Public License Version
* 1.1 (the "License"); you may not use this file except in compliance with
* the License. You may obtain a copy of the License at
* http://www.mozilla.org/MPL/
*
* Software distributed under the License is distributed on an "AS IS" basis,
* WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
* for the specific language governing rights and limitations under the
* License.
*
* The Initial Developer of the Original Code is
*  Joker (http://www.simplemachines.org/community/index.php?action=profile;u=226111)
* Portions created by the Initial Developer are Copyright (C) 2012
* the Initial Developer. All Rights Reserved.
*
* Contributor(s): Big thanks to all contributor(s)
*
*/
 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>sid2varun:customreportmod</id>
	<version>1.4</version>
	
	<file name="$sourcedir/Display.php">
		<operation>
			<search position="replace"><![CDATA[			t.id_member_started, t.id_first_msg, t.id_last_msg, t.approved, t.unapproved_posts,
]]></search>
			<add><![CDATA[			t.id_member_started, t.id_first_msg, t.id_last_msg, t.approved, t.unapproved_posts, c.solved,
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[			INNER JOIN {db_prefix}messages AS ms ON (ms.id_msg = t.id_first_msg)' . ($user_info['is_guest'] ? '' : '
]]></search>
			<add><![CDATA[			INNER JOIN {db_prefix}messages AS ms ON (ms.id_msg = t.id_first_msg)
			LEFT JOIN {db_prefix}custom_report_mod as c ON (c.id_report_topic = {int:current_topic})' . ($user_info['is_guest'] ? '' : '
]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[	$context['topic_last_message'] = $topicinfo['id_last_msg'];
]]></search>
			<add><![CDATA[	$context['report_solved'] = $topicinfo['solved'];
]]></add>
		</operation>
	</file>
	
	<file name="$sourcedir/SendTopic.php">
		<operation>
			<search position="replace"><![CDATA[	if ((isset($_POST[$context['session_var']]) || isset($_POST['submit'])) && empty($context['post_errors']))
		ReportToModerator2();]]></search>
			<add><![CDATA[	if ((isset($_POST[$context['session_var']]) || isset($_POST['submit'])) && empty($context['post_errors']) && !empty($modSettings['report_board']))
			{
		require_once($sourcedir . '/CustomReport.php');
		CustomReportToModerator2();	
	}
	
	elseif ((isset($_POST[$context['session_var']]) || isset($_POST['submit'])) && empty($context['post_errors']))
		ReportToModerator2();]]></add>
		</operation>

		<operation>
			<search position="before"><![CDATA[	$context['comment_body'] = !isset($_POST['comment']) ? '' : trim($_POST['comment']);
	$context['email_address'] = !isset($_POST['email']) ? '' : trim($_POST['email']);]]></search>
			<add><![CDATA[	
	// Ask the name from guests if custom report mod is enabled.
	if(!empty($modSettings['report_board']))
	$context['guestname'] = !isset($_POST['guestname']) ? '' : trim($_POST['guestname']);]]></add>
		</operation>		
	</file>

	<file name="$sourcedir/ManageBoards.php">
		<operation>
			<search position="replace"><![CDATA[	$recycle_boards = array('');
	$request = $smcFunc['db_query']('order_by_board_order', '
		SELECT b.id_board, b.name AS board_name, c.name AS cat_name
		FROM {db_prefix}boards AS b
			LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
		WHERE redirect = {string:empty_string}',
		array(
			'empty_string' => '',
		)
	);
	while ($row = $smcFunc['db_fetch_assoc']($request))
		$recycle_boards[$row['id_board']] = $row['cat_name'] . ' - ' . $row['board_name'];
	$smcFunc['db_free_result']($request);]]></search>
			<add><![CDATA[	$recycle_boards = array('');
	$request = $smcFunc['db_query']('order_by_board_order', '
		SELECT b.id_board, b.name AS board_name, c.name AS cat_name
		FROM {db_prefix}boards AS b
			LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
		WHERE redirect = {string:empty_string}' . (!empty($modSettings['report_board']) && $modSettings['report_board_id'] > 0 ? '
		AND b.id_board != {int:report_board_id}' : ''),
		array(
			'empty_string' => '',
			'report_board_id' => $modSettings['report_board_id'],
		)
	);
	while ($row = $smcFunc['db_fetch_assoc']($request))
		$recycle_boards[$row['id_board']] = $row['cat_name'] . ' - ' . $row['board_name'];
	$smcFunc['db_free_result']($request);
	
	$report_boards = array('');
	$request = $smcFunc['db_query']('order_by_board_order', '
		SELECT b.id_board, b.name AS board_name, c.name AS cat_name
		FROM {db_prefix}boards AS b
			LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
		WHERE redirect = {string:empty_string}' . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
		AND b.id_board != {int:recycle_board_id}' : ''),
		array(
			'empty_string' => '',
			'recycle_board_id' => $modSettings['recycle_board'],
		)
	);
	while ($row = $smcFunc['db_fetch_assoc']($request))
		$report_boards[$row['id_board']] = $row['cat_name'] . ' - ' . $row['board_name'];
	$smcFunc['db_free_result']($request);
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[			// Other board settings.
			array('check', 'countChildPosts'),
			array('check', 'recycle_enable', 'onclick' => 'document.getElementById(\'recycle_board\').disabled = !this.checked;'),
			array('select', 'recycle_board', $recycle_boards),
			array('check', 'allow_ignore_boards'),]]></search>
			<add><![CDATA[			// Other board settings.
			array('check', 'countChildPosts'),
			array('check', 'recycle_enable', 'onclick' => 'document.getElementById(\'recycle_board\').disabled = !this.checked;'),
			array('select', 'recycle_board', $recycle_boards),
			array('check', 'allow_ignore_boards'),
			'',
			array('check', 'report_board', 'onclick' => 'document.getElementById(\'report_board_id\').disabled = !this.checked;'),
			array('select', 'report_board_id', $report_boards),
			array('check', 'quote_reported_post', 'subtext' => $txt['quote_reported_post_info']),
			array('check', 'enable_report_count', 'subtext' => $txt['enable_report_count_info']),
			array('check', 'enable_report_mod_count', 'subtext' => $txt['enable_report_mod_count_info']),
			array('check', 'enable_large_report_field', 'subtext' => $txt['enable_large_report_field_info']),]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[			document.getElementById("recycle_board").disabled = !document.getElementById("recycle_enable").checked;
]]></search>
			<add><![CDATA[			document.getElementById("report_board_id").disabled = !document.getElementById("report_board").checked;
]]></add>
		</operation>
	</file>	

	<file name="$themedir/Display.template.php">
		<operation>
			<search position="after"><![CDATA[		// Maybe they want to report this post to the moderator(s)?]]></search>
			<add><![CDATA[		// A button to be used by moderators only.
		if(($message['id'] == $context['first_message']) && ($context['current_board'] == $modSettings['report_board_id']) && allowedTo('can_solve_report'))
		echo '
								<em><a href="', $scripturl, '?action=report_solved;topic=' . $context['current_topic'] . '">', (empty($context['report_solved'])) ? '[' . $txt['report_solved']. ']' : '[' . $txt['report_unsolved']. ']' , '</a></em>';

]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		if ($context['can_report_moderator'])
]]></search>
			<add><![CDATA[		if ($context['can_report_moderator'] && ($context['current_board'] != $modSettings['report_board_id']))
]]></add>
		</operation>
	</file>

	<file name="$themedir/SendTopic.template.php">
		<operation>
			<search position="replace"><![CDATA[	if ($context['user']['is_guest'])
	{
		echo '
							<dt>
								<label for="email_address">', $txt['email'], '</label>:
							</dt>
							<dd>
								<input type="text" id="email_address" name="email" value="', $context['email_address'], '" size="25" maxlength="255" />
							</dd>';
	}]]></search>
			<add><![CDATA[	if ($context['user']['is_guest'])
	{
		echo '
							<dt>
								<label for="guestname">', $txt['name'], '</label>:
							</dt>
							<dd>
								<input type="text" id="guestname" name="guestname" value="', $context['guestname'], '" size="25" maxlength="255" />
							</dd>';		
		
		echo '
							<dt>
								<label for="email_address">', $txt['email'], '</label>:
							</dt>
							<dd>
								<input type="text" id="email_address" name="email" value="', $context['email_address'], '" size="25" maxlength="255" />
							</dd>';
	}]]></add>
		</operation>
	</file>
</modification>
